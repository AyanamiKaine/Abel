name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: read

jobs:
  publish-nuget:
    name: Publish NuGet Tool
    runs-on: ubuntu-latest

    env:
      DOTNET_NOLOGO: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Require successful CI for this commit
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;

            const response = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: "ci.yml",
              head_sha: sha,
              per_page: 50,
            });

            const successfulRun = response.data.workflow_runs.find(
              run => run.status === "completed" && run.conclusion === "success"
            );

            if (!successfulRun) {
              core.setFailed(
                `No successful CI run from 'ci.yml' found for commit ${sha}. ` +
                `Publish is blocked until CI passes.`
              );
              return;
            }

            core.notice(
              `Using CI run #${successfulRun.run_number} (${successfulRun.html_url}) ` +
              `for commit ${sha}.`
            );

      - name: Install Linux build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++

      - name: Resolve version and validate tag
        id: version
        shell: bash
        run: |
          CSPROJ_VERSION="$(grep -oPm1 '(?<=<Version>)[^<]+' Abel/Abel.csproj)"
          if [ -z "$CSPROJ_VERSION" ]; then
            echo "::error::Could not read <Version> from Abel/Abel.csproj"
            exit 1
          fi

          if [[ "${GITHUB_REF_TYPE}" != "tag" ]]; then
            echo "::error::Release workflow must run from a version tag (for example: v$CSPROJ_VERSION)."
            exit 1
          fi

          TAG_VERSION="${GITHUB_REF_NAME#v}"
          if [ "$TAG_VERSION" != "$CSPROJ_VERSION" ]; then
            echo "::error::Tag version '$TAG_VERSION' does not match csproj version '$CSPROJ_VERSION'."
            exit 1
          fi

          echo "package_version=$CSPROJ_VERSION" >> "$GITHUB_OUTPUT"

      - name: Build
        run: dotnet build Abel/Abel.csproj -c Release

      - name: Pack
        run: dotnet pack Abel/Abel.csproj -c Release -o artifacts/nupkg

      - name: Smoke test packaged tool
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.package_version }}"
          dotnet tool install Abel.Tool --tool-path ./.tools --add-source artifacts/nupkg --version "$VERSION"
          ./.tools/abel --version
          ./.tools/abel init ci_release_smoke
          ./.tools/abel add --project ./ci_release_smoke fmt
          ./.tools/abel build ./ci_release_smoke

      - name: Publish to NuGet
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        shell: bash
        run: |
          if [ -z "$NUGET_API_KEY" ]; then
            echo "::error::Missing secret NUGET_API_KEY."
            exit 1
          fi

          VERSION="${{ steps.version.outputs.package_version }}"
          PACKAGE="artifacts/nupkg/Abel.Tool.${VERSION}.nupkg"
          if [ ! -f "$PACKAGE" ]; then
            echo "::error::Package not found: $PACKAGE"
            exit 1
          fi

          dotnet nuget push "$PACKAGE" \
            --source "https://api.nuget.org/v3/index.json" \
            --api-key "$NUGET_API_KEY" \
            --skip-duplicate
