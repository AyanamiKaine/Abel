name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-smoke:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    defaults:
      run:
        shell: pwsh

    env:
      DOTNET_NOLOGO: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Linux build tools
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build gcc-14 g++-14
          echo "CC=gcc-14" >> "$GITHUB_ENV"
          echo "CXX=g++-14" >> "$GITHUB_ENV"

      - name: Ensure Ninja on Windows
        if: runner.os == 'Windows'
        run: |
          choco install ninja -y --no-progress
          # Point CMake at LLVM Clang (already on the runner) instead of whichever
          # MinGW g++ appears first in PATH (mingw64, Strawberry, etc.).
          # MinGW's C++23 libstdc++ is missing std::__open_terminal / std::__write_to_terminal.
          $llvmBin = 'C:\Program Files\LLVM\bin'
          Add-Content $env:GITHUB_ENV "CC=$llvmBin\clang.exe"
          Add-Content $env:GITHUB_ENV "CXX=$llvmBin\clang++.exe"

      - name: Build Abel
        run: dotnet build Abel/Abel.csproj -c Release

      - name: Check environment
        run: dotnet run --project Abel/Abel.csproj -- check --verbose

      - name: Pack tool
        run: dotnet pack Abel/Abel.csproj -c Release -o artifacts/nupkg

      - name: Install local tool package
        run: |
          $version = (Select-String -Path Abel/Abel.csproj -Pattern '<Version>([^<]+)</Version>').Matches[0].Groups[1].Value
          dotnet tool install Abel.Tool --tool-path ./.tools --add-source artifacts/nupkg --version $version

      - name: CLI smoke test
        run: |
          $abel = Join-Path (Resolve-Path ./.tools) 'abel'
          if ($IsWindows) { $abel = "$abel.exe" }

          & $abel --version
          & $abel init ci_smoke
          & $abel add --project ./ci_smoke fmt
          & $abel build ./ci_smoke
